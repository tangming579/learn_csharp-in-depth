## 第五章 进入快速通道的委托

### 委托的逆变性与协变性

- 协变性是指方法能返回从委托的**返回类型派生**的一个类型。
- 逆变性是指方法获取的参数可以是委托的**参数类型的基类**。

```csharp
delegate Object MyCallback(FileStream s);
string SomeMethod(Stream s);
```

如上面的例子，SomeMethod 的返回类型(string)派生自委托的返回类型(Object)；这种协变性是允许的。SomeMethod 的参数类型(Stream)是委托的参数类型(FileStream)的基类；这种逆变性是允许的。

注意：**只有引用类型才支持协变性与逆变性，值类型或void不支持。**所以不能把下面的方法绑定到MyCallBack委托：

```csharp
int SomeOtherMethod(Stream s);
```

虽然 SomeOtherMethod 的返回类型(int)派生自MyCallback的返回类型(Object)，但这种形式的协变性是不允许的，因为int是值类型。显然，值类型和void之所以不支持，**是因为它们的存储结构是变化的，而引用类型的存储结构始终是一个指针。**

### 匿名方法中捕获变量

闭包：一个函数除了能通过提供给它的参数交互外，还能同环境进行更大程度的互动。

- 外部变量（out variable）是指作用域（scope）内包括匿名方法的局部变量或参数。
- 捕获的外部变量（captured out variable）通常简称为捕获变量，它是在匿名方法内部使用的外部变量

简而言之：匿名方法能使用在声明该匿名方法的方法内部定义的局部变量。

对于一个捕获变量，只要还有任何委托实例在引用它，他就会一直存在。

使用捕获变量的原则：

- 如果用或不用捕获变量时的代码同样简单，那就不要用。
- 捕获由for或foreach语句声明的变量之前，思考你的委托是否需要在循环迭代之后延续，以及是否想让它看到那个变量的后续值。如果不是，那就在循环内另建一个变量，用来复制你想要的值。
- 如果创建多个委托实例，而且捕获了变量，思考一些是否希望它们捕捉同一个变量。
- 如果捕捉的变量不会发生改变，就不需要有那么多担心。
- 如果创建的委托实例永远不从方法中“逃脱”（永远不会存储到别的地方、不会返回、不会用于启动线程），那么事情就会简单很多。
- 从垃圾回收的角度，思考任何捕获变量被延长的生命期。

